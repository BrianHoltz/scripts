#!/bin/zsh
# mdar_test: Thorough and realistic testing for mdar
# Tests: propose moves, normalize, prune, and sort recommendations
# Usage: mdar_test [--setup-only] [--keep-artifacts]
#
# --setup-only: Create a realistic folder/file tree for experimentation
# --keep-artifacts: Do not clean up test directories after running

set -e

# Test counters must be global for test_case to increment them
passed=0
failed=0

# Ensure running under zsh for robust behavior
if [ -z "$ZSH_VERSION" ]; then
  exec zsh "$0" "$@"
fi

show_help() {
  echo "Usage: $0 [--setup-only] [--keep-artifacts]"
  echo "  --setup-only     Create a realistic folder/file tree for mdar testing."
  echo "  --keep-artifacts Do not clean up test directories after running."
  exit 1
}

# Generate a realistic folder/file tree with empty files
setup_only() {
  local root="$1"
  mkdir -p "$root"
  mkdir -p "$root/Project Alpha/Docs"
  mkdir -p "$root/Project Alpha/Data"
  mkdir -p "$root/Project Beta/Images"
  mkdir -p "$root/Project Beta/Notes"
  mkdir -p "$root/Personal/Finances"
  mkdir -p "$root/Personal/Photos/2025"
  touch "$root/Project Alpha/README.md"
  touch "$root/Project Alpha/Docs/Spec v1.0.txt"
  touch "$root/Project Alpha/Data/data_01.csv"
  touch "$root/Project Beta/Images/logo-final (1).png"
  touch "$root/Project Beta/Notes/meeting notes (Nov 19).md"
  touch "$root/Personal/Finances/budget_2025.xlsx"
  touch "$root/Personal/Photos/2025/vacation photo 1.jpg"
  touch "$root/Personal/Photos/2025/vacation photo 2.jpg"
  touch "$root/Personal/Photos/2025/.DS_Store"
  touch "$root/emptyfile"
}

# Color helpers
color_pass() {
  if [ -t 1 ]; then
    printf '\033[1;32mPASS: %s\033[0m\n' "$1"
  else
    echo "PASS: $1"
  fi
}
color_fail() {
  if [ -t 1 ]; then
    printf '\033[1;31mFAIL: %s\033[0m\n' "$1"
  else
    echo "FAIL: $1"
  fi
}
header() {
  local text="$1"
  if [ -t 1 ]; then
    printf '\033[1m%s\033[0m\n' "$text"
  else
    echo "$text"
  fi
}

# Run a single test case
# Rewritten to use an absolute tempfile (LAST_OUTFILE) so output is always captured
# and not dependent on the current working directory.

test_case() {
  local desc="$1"
  local cmd="$2"
  local expect="$3"
  shift 3
  local bullets=("$@")
  header "### Test: $desc"
  for b in "${bullets[@]}"; do
    [[ -n "$b" ]] && echo "- $b"
  done
  echo '```'
  LAST_OUTFILE=$(mktemp /tmp/mdar_test_out.XXXXXX)
  eval "$cmd" >"$LAST_OUTFILE" 2>&1 || true
  cat "$LAST_OUTFILE"
  local result=1
  if grep -q "$expect" "$LAST_OUTFILE"; then
    result=0
  else
    echo '```'
    color_fail "$desc"
    echo "  Command: $cmd"
    echo "  Expected: $expect"
    echo "  Output file: $LAST_OUTFILE"
    echo "  Output:"
    sed -n '1,200p' "$LAST_OUTFILE"
  fi
  echo '```'
  if [[ $result -eq 0 ]]; then
    color_pass "$desc"
    ((passed++))
  else
    ((failed++))
  fi
  return $result
}

# Global test directory for all test cases
# Must be set before run_tests so all test_case invocations use the correct path
TESTDIR=""

extract_usageMsg() {
  "$HOME/bin/mdar" -H
}

# Main test suite
if [[ $verboseTest -eq 1 ]]; then
  echo "mdar_test script started"
fi

run_tests() {
  set +e  # Disable exit-on-error so all tests run
  TESTDIR=$(mktemp -d)
  [ "$verboseTest" -eq 1 ] && echo "Created TESTDIR: $TESTDIR"
  local testdir="$TESTDIR"
  local setup_msgs=()
  setup_only "$testdir/tree"
  setup_msgs+=("Created folder tree at $testdir/tree")
  # Backdate files in the generated tree to a mix of datetimes
  touch -t 201801010101 "$testdir/tree/Project Alpha/README.md"
  touch -t 201902020202 "$testdir/tree/Project Beta/Notes/meeting notes (Nov 19).md"
  touch -t 202003030303 "$testdir/tree/Project Alpha/Docs/Spec v1.0.txt"
  touch -t 202104040404 "$testdir/tree/Project Alpha/Data/data_01.csv"
  touch -t 202205050505 "$testdir/tree/Personal/Finances/budget_2025.xlsx"
  touch -t 202306060606 "$testdir/tree/Personal/Photos/2025/vacation photo 1.jpg"
  touch -t 202307070707 "$testdir/tree/Personal/Photos/2025/vacation photo 2.jpg"
  touch -t 202308080808 "$testdir/tree/emptyfile"

  # Per-test setup for test 1
  mkdir -p "$testdir/tree/testdir"
  echo "# Test MD file" > "$testdir/tree/testdir/testfile.md"
  touch -t 202404040404 "$testdir/tree/testdir/testfile.md"
  local test1_msg="Created test markdown file at $testdir/tree/testdir/testfile.md"

  # Per-test setup for test 2
  mkdir -p "$testdir/tree/test-results"
  echo "Sample" > "$testdir/tree/test-results/summary 2025.txt"
  touch -t 202212121212 "$testdir/tree/test-results/summary 2025.txt"
  local test2_msg="Created test-results file to normalize: $testdir/tree/test-results/summary 2025.txt"

  # Per-test setup for test 3
  mkdir -p "$testdir/tree/aidocs/2019-01-01"
  echo "Old content" > "$testdir/tree/aidocs/2019-01-01/0000_Old.md"
  touch -t 201701010000 "$testdir/tree/aidocs/2019-01-01/0000_Old.md"
  local test3_msg="Created old aidocs file for prune test: $testdir/tree/aidocs/2019-01-01/0000_Old.md"

  # Per-test setup for test 4 (prune in test-results)
  mkdir -p "$testdir/tree/test-results"
  echo "Old test result" > "$testdir/tree/test-results/old_result.txt"
  touch -t 201701010000 "$testdir/tree/test-results/old_result.txt"
  local test4_msg="Created old test-results file for prune test: $testdir/tree/test-results/old_result.txt"

  header "### Test Setup"
  for msg in "${setup_msgs[@]}"; do
    echo "- $msg"
  done

  # USAGE MSG vs --help output test
  header "### Usage Message Consistency Test"
  local usage_raw usage_help usage_raw_file usage_help_file usage_diff_file
  usage_raw_file=$(mktemp /tmp/mdar_usage_raw.XXXXXX)
  usage_help_file=$(mktemp /tmp/mdar_usage_help.XXXXXX)
  usage_diff_file=$(mktemp /tmp/mdar_usage_diff.XXXXXX)
  extract_usageMsg > "$usage_raw_file"
  "$HOME/bin/mdar" --help | perl -pe 's/\e\[[\d;]*[A-Za-z]//g' > "$usage_help_file"
  diff -u "$usage_raw_file" "$usage_help_file" > "$usage_diff_file"
  if [ -s "$usage_diff_file" ]; then
    color_fail "mdar usageMsg matches --help output"
    echo "DIFFERENCES FOUND:" >&2
    cat "$usage_diff_file"
    ((failed++))
  else
    color_pass "mdar usageMsg matches --help output"
    ((passed++))
  fi
  rm -f "$usage_raw_file" "$usage_help_file" "$usage_diff_file"

  testDescriptions=(
    "mdar proposes move for untracked .md file"
    "mdar suggests normalization for test-results files"
    "mdar marks old aidocs files for pruning"
    "mdar prunes old files in test-results/"
    "mdar sorts recommended target names (by mtime and name)"
  )
  testCommands=(
    "cd $testdir/tree && $mdar_cmd -n --depth 3 --yes"
    "cd $testdir/tree && $mdar_cmd -n --normalize test-results --depth 3 --yes"
    "cd $testdir/tree && $mdar_cmd -n --prune 2000d --depth 3 --yes"
    "cd $testdir/tree && $mdar_cmd -n --prune 2000d --depth 3 --yes --archive test-results"
    "cd $testdir/tree/sorttest && $mdar_cmd -n --depth 2 --yes"
  )
  testExpects=(
    "aidocs/"
    "test-results/"
    "\[DELETE\]"
    "\[DELETE\]"
    "→"
  )
  testBullets=(
    "$test1_msg"
    "$test2_msg"
    "$test3_msg"
    "$test4_msg"
    "Sorting test files with mixed mtimes (including same mtime to verify name sorting)"
  )

  [ "$verboseTest" -eq 1 ] && echo "Files in $TESTDIR/tree before test 1:" && find $TESTDIR/tree -type f
  if [[ $mdarTrace -eq 1 ]]; then
    mdar_cmd="$HOME/bin/mdar -x"
  else
    mdar_cmd="$HOME/bin/mdar"
  fi
  [ "$verboseTest" -eq 1 ] && mdar_cmd+=" -v"
  test_case "mdar proposes move for untracked .md file" \
    "cd $TESTDIR/tree && $mdar_cmd -n --depth 3 --yes" \
    "aidocs/" \
    "$test1_msg"
  [ "$verboseTest" -eq 1 ] && echo "Completed test 1"

  [ "$verboseTest" -eq 1 ] && echo "Files in $TESTDIR/tree before test 2:" && find $TESTDIR/tree -type f
  test_case "mdar suggests normalization for test-results files" \
    "cd $TESTDIR/tree && $mdar_cmd -n --normalize test-results --depth 3 --yes" \
    "test-results/" \
    "$test2_msg"
  [ "$verboseTest" -eq 1 ] && echo "Completed test 2"

  [ "$verboseTest" -eq 1 ] && echo "Files in $TESTDIR/tree before test 3:" && find $TESTDIR/tree -type f
  test_case "mdar marks old aidocs files for pruning" \
    "cd $TESTDIR/tree && $mdar_cmd -n --prune 2000d --depth 3 --yes" \
    "\[DELETE\]" \
    "$test3_msg"
  [ "$verboseTest" -eq 1 ] && echo "Completed test 3"

  [ "$verboseTest" -eq 1 ] && echo "Files in $TESTDIR/tree before test 4:" && find $TESTDIR/tree -type f
  test_case "mdar prunes old files in test-results/" \
    "cd $TESTDIR/tree && $mdar_cmd -n --prune 2000d --depth 3 --yes --archive test-results" \
    "\[DELETE\]" \
    "$test4_msg"
  [ "$verboseTest" -eq 1 ] && echo "Completed test 4"

  # Fourth test: mdar sorts recommended target names (by mtime and name)
  # Use realistic past dates, and include files with same mtime to test name sorting
  mkdir -p "$testdir/tree/sorttest/testdir"
  setopt null_glob
  rm -f "$testdir/tree/sorttest/testdir"/*
  unsetopt null_glob
  echo "Zeta" > "$testdir/tree/sorttest/testdir/zeta_notes.md"
  touch -t 202301150900 "$testdir/tree/sorttest/testdir/zeta_notes.md"
  echo "Alpha" > "$testdir/tree/sorttest/testdir/alpha_notes.md"
  touch -t 202403221430 "$testdir/tree/sorttest/testdir/alpha_notes.md"
  echo "Beta" > "$testdir/tree/sorttest/testdir/beta_notes.md"
  touch -t 202403221445 "$testdir/tree/sorttest/testdir/beta_notes.md"
  echo "Delta" > "$testdir/tree/sorttest/testdir/delta_notes.md"
  touch -t 202506180830 "$testdir/tree/sorttest/testdir/delta_notes.md"
  echo "Gamma" > "$testdir/tree/sorttest/testdir/gamma_notes.md"
  touch -t 202510011200 "$testdir/tree/sorttest/testdir/gamma_notes.md"
  [ "$verboseTest" -eq 1 ] && echo "Files in $testdir/tree/sorttest before sorting test:" && find $testdir/tree/sorttest -type f
  test_case "mdar sorts recommended target names (by mtime and name)" \
    "cd $testdir/tree/sorttest && $mdar_cmd -n --depth 2 --yes" \
    "→" \
    "Sorting test files with mixed mtimes (including same mtime to verify name sorting)"
  [ "$verboseTest" -eq 1 ] && echo "Completed sorting test"

  header "### Test Summary"
  total_tests=$((passed+failed))
  summary="Results: Tests run: $total_tests, Failures: $failed, Successes: $passed"
  if [ -t 1 ]; then
    color_reset='\033[0m'
    color_green='\033[1;32m'
    color_red='\033[1;31m'
    summary_colored="Results: Tests run: $((passed+failed)), "
    if [[ $failed -gt 0 ]]; then
      summary_colored+="${color_red}Failures${color_reset}: ${color_red}$failed${color_reset}"
    else
      summary_colored+="Failures: $failed"
    fi
    summary_colored+=", "
    if [[ $passed -gt 0 ]]; then
      summary_colored+="${color_green}Successes${color_reset}: ${color_green}$passed${color_reset}"
    else
      summary_colored+="Successes: $passed"
    fi
    printf '%b\n' "$summary_colored"
  else
    echo "$summary"
  fi

  if [[ "$KEEP_ARTIFACTS" != "1" ]]; then
    rm -rf "$testdir"
  else
    echo "Test artifacts kept at $testdir"
  fi
}

# Parse arguments
setupOnly=0
keepArtifacts=0
shellTrace=0
mdarTrace=0
verboseTest=0
listTests=0
ignoreTests=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --setup-only)
      setupOnly=1 ;;
    --keep-artifacts)
      keepArtifacts=1 ;;
    -x)
      shellTrace=1 ;;
    -xx)
      mdarTrace=1 ;;
    -v)
      verboseTest=1 ;;
    --list-tests)
      listTests=1 ;;
    --ignore-tests)
      shift
      IFS="," read -r -A ignoreTests <<< "$1" ;;
    -h|--help)
      show_help ;;
    *)
      echo "Unknown option: $1"
      show_help ;;
  esac
  shift
done

# Export KEEP_ARTIFACTS so run_tests can read it (it checks this env var)
if [[ $keepArtifacts -eq 1 ]]; then
  export KEEP_ARTIFACTS=1
fi

if [[ $shellTrace -eq 1 ]]; then
  set -x
fi

if [[ $setupOnly -eq 1 ]]; then
  setup_only "./mdar_test_tree"
  exit 0
fi

# Now run the main test suite. run_tests creates TESTDIR and executes tests.
run_tests
