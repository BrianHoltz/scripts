#!/bin/zsh
# mdar_test: Thorough and realistic testing for mdar
# Tests: propose moves, normalize, prune, and sort recommendations
# Usage: mdar_test [--setup-only] [--keep-artifacts]
#
# --setup-only: Create a realistic folder/file tree for experimentation
# --keep-artifacts: Do not clean up test directories after running

set -e

# Test counters must be global for test_case to increment them
passed=0
failed=0

# Ensure running under zsh for robust behavior
if [ -z "$ZSH_VERSION" ]; then
  exec zsh "$0" "$@"
fi

show_help() {
  echo "Usage: $0 [--setup-only] [--keep-artifacts]"
  echo "  --setup-only     Create a realistic folder/file tree for mdar testing."
  echo "  --keep-artifacts Do not clean up test directories after running."
  exit 1
}

# Generate a realistic folder/file tree with empty files
setup_only() {
  local root="$1"
  mkdir -p "$root"
  mkdir -p "$root/Project Alpha/Docs"
  mkdir -p "$root/Project Alpha/Data"
  mkdir -p "$root/Project Beta/Images"
  mkdir -p "$root/Project Beta/Notes"
  mkdir -p "$root/Personal/Finances"
  mkdir -p "$root/Personal/Photos/2025"
  touch "$root/Project Alpha/README.md"
  touch "$root/Project Alpha/Docs/Spec v1.0.txt"
  touch "$root/Project Alpha/Data/data_01.csv"
  touch "$root/Project Beta/Images/logo-final (1).png"
  touch "$root/Project Beta/Notes/meeting notes (Nov 19).md"
  touch "$root/Personal/Finances/budget_2025.xlsx"
  touch "$root/Personal/Photos/2025/vacation photo 1.jpg"
  touch "$root/Personal/Photos/2025/vacation photo 2.jpg"
  touch "$root/Personal/Photos/2025/.DS_Store"
  touch "$root/emptyfile"
}

# Color helpers
color_pass() {
  if [ -t 1 ]; then
    printf '\033[1;32mPASS: %s\033[0m\n' "$1"
  else
    echo "PASS: $1"
  fi
}
color_fail() {
  if [ -t 1 ]; then
    printf '\033[1;31mFAIL: %s\033[0m\n' "$1"
  else
    echo "FAIL: $1"
  fi
}
header() {
  local text="$1"
  if [ -t 1 ]; then
    printf '\033[1m%s\033[0m\n' "$text"
  else
    echo "$text"
  fi
}

# Run a single test case
# Rewritten to use an absolute tempfile (LAST_OUTFILE) so output is always captured
# and not dependent on the current working directory.

test_case() {
  local desc="$1"
  local cmd="$2"
  local expect="$3"
  shift 3
  local bullets=("$@")
  header "### Test: $desc"
  for b in "${bullets[@]}"; do
    [[ -n "$b" ]] && echo "- $b"
  done
  echo '```'
  LAST_OUTFILE=$(mktemp /tmp/mdar_test_out.XXXXXX)
  eval "$cmd" >"$LAST_OUTFILE" 2>&1 || true
  cat "$LAST_OUTFILE"
  local result=1
  if grep -q "$expect" "$LAST_OUTFILE"; then
    result=0
  else
    echo '```'
    color_fail "$desc"
    echo "  Command: $cmd"
    echo "  Expected: $expect"
    echo "  Output file: $LAST_OUTFILE"
    echo "  Output:"
    sed -n '1,200p' "$LAST_OUTFILE"
  fi
  echo '```'
  if [[ $result -eq 0 ]]; then
    color_pass "$desc"
    ((passed++))
  else
    ((failed++))
  fi
  return $result
}

# Main test suite
run_tests() {
  set +e  # Disable exit-on-error so all tests run
  local testdir
  testdir=$(mktemp -d)
  local setup_msgs=()
  setup_only "$testdir/tree"
  setup_msgs+=("Created folder tree at $testdir/tree")
  # Backdate files in the generated tree to a mix of datetimes
  touch -t 201801010101 "$testdir/tree/Project Alpha/README.md"
  touch -t 201902020202 "$testdir/tree/Project Beta/Notes/meeting notes (Nov 19).md"
  touch -t 202003030303 "$testdir/tree/Project Alpha/Docs/Spec v1.0.txt"
  touch -t 202104040404 "$testdir/tree/Project Alpha/Data/data_01.csv"
  touch -t 202205050505 "$testdir/tree/Personal/Finances/budget_2025.xlsx"
  touch -t 202306060606 "$testdir/tree/Personal/Photos/2025/vacation photo 1.jpg"
  touch -t 202307070707 "$testdir/tree/Personal/Photos/2025/vacation photo 2.jpg"
  touch -t 202308080808 "$testdir/tree/emptyfile"

  # Per-test setup for test 1
  mkdir -p "$testdir/tree/testdir"
  echo "# Test MD file" > "$testdir/tree/testdir/testfile.md"
  touch -t 202404040404 "$testdir/tree/testdir/testfile.md"
  local test1_msg="Created test markdown file at $testdir/tree/testdir/testfile.md"

  # Per-test setup for test 2
  mkdir -p "$testdir/tree/test-results"
  echo "Sample" > "$testdir/tree/test-results/summary 2025.txt"
  touch -t 202212121212 "$testdir/tree/test-results/summary 2025.txt"
  local test2_msg="Created test-results file to normalize: $testdir/tree/test-results/summary 2025.txt"

  # Per-test setup for test 3
  mkdir -p "$testdir/tree/aidocs/2019-01-01"
  echo "Old content" > "$testdir/tree/aidocs/2019-01-01/0000_Old.md"
  touch -t 201701010000 "$testdir/tree/aidocs/2019-01-01/0000_Old.md"
  local test3_msg="Created old aidocs file for prune test: $testdir/tree/aidocs/2019-01-01/0000_Old.md"

  header "### Test Setup"
  for msg in "${setup_msgs[@]}"; do
    echo "- $msg"
  done

  test_case "mdar proposes move for untracked .md file" \
    "cd $testdir/tree && /Users/brian/bin/mdar -n --depth 3 --yes" \
    "aidocs/" \
    "$test1_msg"

  test_case "mdar suggests normalization for test-results files" \
    "cd $testdir/tree && /Users/brian/bin/mdar -n --normalize test-results --depth 3 --yes" \
    "test-results/" \
    "$test2_msg"

  test_case "mdar marks old aidocs files for pruning" \
    "cd $testdir/tree && /Users/brian/bin/mdar -n --prune 2000d --depth 3 --yes" \
    "\[DELETE\]" \
    "$test3_msg"

  # Fourth test: mdar sorts recommended target names (by mtime and name)
  # Use realistic past dates, and include files with same mtime to test name sorting
  mkdir -p "$testdir/tree/sorttest/testdir"
  setopt null_glob
  rm -f "$testdir/tree/sorttest/testdir"/*
  unsetopt null_glob
  echo "Zeta" > "$testdir/tree/sorttest/testdir/zeta_notes.md"
  touch -t 202301150900 "$testdir/tree/sorttest/testdir/zeta_notes.md"
  echo "Alpha" > "$testdir/tree/sorttest/testdir/alpha_notes.md"
  touch -t 202403221430 "$testdir/tree/sorttest/testdir/alpha_notes.md"
  echo "Beta" > "$testdir/tree/sorttest/testdir/beta_notes.md"
  touch -t 202403221445 "$testdir/tree/sorttest/testdir/beta_notes.md"
  echo "Delta" > "$testdir/tree/sorttest/testdir/delta_notes.md"
  touch -t 202506180830 "$testdir/tree/sorttest/testdir/delta_notes.md"
  echo "Gamma" > "$testdir/tree/sorttest/testdir/gamma_notes.md"
  touch -t 202510011200 "$testdir/tree/sorttest/testdir/gamma_notes.md"
  test_case "mdar sorts recommended target names (by mtime and name)" \
    "cd $testdir/tree/sorttest && /Users/brian/bin/mdar -n --depth 2 --yes" \
    "â†’" \
    "Sorting test files with mixed mtimes (including same mtime to verify name sorting)"

  header "### Test Summary"
  local total_tests=$((passed+failed))
  local summary="Results: Tests run: $total_tests, Failures: $failed, Successes: $passed"
  if [ -t 1 ]; then
    local color_reset='\033[0m'
    local color_green='\033[1;32m'
    local color_red='\033[1;31m'
    local summary_colored="Results: Tests run: $((passed+failed)), "
    if [[ $failed -gt 0 ]]; then
      summary_colored+="${color_red}Failures${color_reset}: ${color_red}$failed${color_reset}"
    else
      summary_colored+="Failures: $failed"
    fi
    summary_colored+=", "
    if [[ $passed -gt 0 ]]; then
      summary_colored+="${color_green}Successes${color_reset}: ${color_green}$passed${color_reset}"
    else
      summary_colored+="Successes: $passed"
    fi
    printf '%b\n' "$summary_colored"
  else
    echo "$summary"
  fi

  if [[ "$KEEP_ARTIFACTS" != "1" ]]; then
    rm -rf "$testdir"
  else
    echo "Test artifacts kept at $testdir"
  fi
}

# Parse arguments
SETUP_ONLY=0
KEEP_ARTIFACTS=0
VERBOSE=0
while [[ $# -gt 0 ]]; do
  case "$1" in
    --setup-only)
      SETUP_ONLY=1
      ;;
    --keep-artifacts)
      KEEP_ARTIFACTS=1
      ;;
    -v|--verbose)
      VERBOSE=1
      ;;
    -h|--help)
      show_help
      ;;
    *)
      echo "Unknown option: $1"
      show_help
      ;;
  esac
  shift
done

if [[ $SETUP_ONLY -eq 1 ]]; then
  setup_only "./mdar_test_tree"
fi
if [[ $SETUP_ONLY -eq 0 ]]; then
  VERBOSE=1
  run_tests
fi
